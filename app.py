# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1F5Tlxjq88cSj0qLHYGux-UeqhFzI4Js8
"""

import dash
from dash import dcc, html, Input, Output, dash_table, State
import plotly.express as px
import plotly.graph_objects as go
from plotly.subplots import make_subplots
import pandas as pd
import numpy as np
from datetime import datetime
import os

# Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ…
df = pd.read_excel('GlobalTemperatures_Optimized_Half1.xlsx')
df['Ð”Ð°Ñ‚Ð°'] = pd.to_datetime(df['Ð”Ð°Ñ‚Ð°'])

# Ð£Ð±ÐµÐ´Ð¸Ð¼ÑÑ, Ñ‡Ñ‚Ð¾ Ð²ÑÐµ ÐºÐ¾Ð»Ð¾Ð½ÐºÐ¸ Ñ‡Ð¸ÑÐ»Ð¾Ð²Ñ‹Ðµ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹
numeric_cols = ['Ð¡Ñ€ÐµÐ´Ð½ÑÑÐ¢ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ð°', 'ÐÐµÐ¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒÐ¢ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ñ‹', 'Ð“Ð¾Ð´', 'ÐœÐµÑÑÑ†',
                'ÐÐ±ÑÐ¾Ð»ÑŽÑ‚Ð½Ð°ÑÐ¨Ð¸Ñ€Ð¾Ñ‚Ð°', 'ÐŸÐ¾Ð»ÑƒÑˆÐ°Ñ€Ð¸Ðµ', 'Ð’Ñ€ÐµÐ¼ÑÐ“Ð¾Ð´Ð°']
df[numeric_cols] = df[numeric_cols].apply(pd.to_numeric, errors='coerce')

# Ð£Ð½Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ðµ ÑÑ‚Ñ€Ð°Ð½Ñ‹ Ð¸ Ð³Ð¾Ñ€Ð¾Ð´Ð° Ð´Ð»Ñ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð¾Ð²
countries = ['All'] + sorted(df['Ð¡Ñ‚Ñ€Ð°Ð½Ð°'].dropna().unique().tolist())
cities = ['All'] + sorted(df['Ð“Ð¾Ñ€Ð¾Ð´'].dropna().unique().tolist())
years = sorted(df['Ð“Ð¾Ð´'].dropna().unique())

# Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Dash-Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
app = dash.Dash(__name__, suppress_callback_exceptions=True,
                external_stylesheets=["https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"])
server = app.server  # â† Ð´Ð»Ñ Render

# ÐÐ°Ð²Ð¸Ð³Ð°Ñ†Ð¸Ñ
app.layout = html.Div([
    dcc.Location(id='url', refresh=False),
    html.Div([
        html.H1("ðŸŒ Environmental Impact Monitor", className="text-center my-4"),
        html.Div([
            dcc.Link("ðŸ“Š Raw Data Visualization", href="/", className="btn btn-outline-primary m-2"),
            dcc.Link("ðŸ” Analysis Results", href="/analysis", className="btn btn-outline-success m-2")
        ], className="text-center mb-4")
    ]),
    html.Div(id='page-content')
])

# Ð¡Ñ‚Ñ€Ð°Ð½Ð¸Ñ†Ð° 1: Ð˜ÑÑ…Ð¾Ð´Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ
raw_layout = html.Div([
    html.H2("ðŸ“Š Raw Data Visualization", className="text-center mb-4"),

    # Ð¤Ð¸Ð»ÑŒÑ‚Ñ€Ñ‹
    html.Div([
        html.Div([
            html.Label("Ð¡Ñ‚Ñ€Ð°Ð½Ð°:", className="form-label"),
            dcc.Dropdown(id='country-filter', options=[{'label': c, 'value': c} for c in countries],
                         value='All', className="form-control")
        ], className="col-md-3"),
        html.Div([
            html.Label("Ð“Ð¾Ñ€Ð¾Ð´:", className="form-label"),
            dcc.Dropdown(id='city-filter', options=[{'label': c, 'value': c} for c in cities],
                         value='All', className="form-control")
        ], className="col-md-3"),
        html.Div([
            html.Label("Ð“Ð¾Ð´Ñ‹:", className="form-label"),
            dcc.RangeSlider(id='year-slider', min=min(years), max=max(years),
                            value=[min(years), max(years)], marks={y: str(y) for y in range(min(years), max(years)+1, 20)},
                            className="mt-2")
        ], className="col-md-6")
    ], className="row mb-4"),

    # KPI-ÐºÐ°Ñ€Ñ‚Ð¾Ñ‡ÐºÐ¸
    html.Div(id='kpi-cards', className="row mb-4"),

    # Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð°
    html.Div([
        dash_table.DataTable(
            id='data-table',
            columns=[{"name": i, "id": i} for i in df.columns if i in ['Ð”Ð°Ñ‚Ð°', 'Ð“Ð¾Ð´', 'ÐœÐµÑÑÑ†', 'Ð¡Ñ‚Ñ€Ð°Ð½Ð°', 'Ð“Ð¾Ñ€Ð¾Ð´', 'Ð¡Ñ€ÐµÐ´Ð½ÑÑÐ¢ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ð°']],
            page_size=10,
            sort_action='native',
            filter_action='native',
            style_table={'overflowX': 'auto'},
            style_cell={'textAlign': 'left', 'padding': '5px'}
        )
    ], className="mb-4"),

    # Ð“Ñ€Ð°Ñ„Ð¸ÐºÐ¸
    html.Div([
        html.Div(dcc.Graph(id='hist-plot'), className="col-md-6"),
        html.Div(dcc.Graph(id='box-plot'), className="col-md-6"),
    ], className="row mb-4"),

    html.Div(dcc.Graph(id='correlation-heatmap'), className="mb-4"),
    html.Div(dcc.Graph(id='scatter-pair'), className="mb-4"),
])

# Ð¡Ñ‚Ñ€Ð°Ð½Ð¸Ñ†Ð° 2: Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°
analysis_layout = html.Div([
    html.H2("ðŸ” Analysis Results", className="text-center mb-4"),

    html.Div([
        html.Div([
            html.Label("Ð’Ñ‹Ð±Ð¾Ñ€ Ð¼Ð¾Ð´ÐµÐ»Ð¸:", className="form-label"),
            dcc.RadioItems(
                id='model-selector',
                options=[
                    {'label': 'ARIMA Forecast', 'value': 'arima'},
                    {'label': 'Clustering (K=5)', 'value': 'cluster'}
                ],
                value='arima',
                labelStyle={'display': 'block'}
            )
        ], className="col-md-3"),
        html.Div([
            html.Div(id='metrics-cards', className="row")
        ], className="col-md-9")
    ], className="row mb-4"),

    html.Div(dcc.Graph(id='analysis-graph'), className="mb-4"),
    html.Div(id='insights-text', className="alert alert-info")
])

# Callback Ð´Ð»Ñ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ð¸Ð·Ð°Ñ†Ð¸Ð¸
@app.callback(Output('page-content', 'children'),
              Input('url', 'pathname'))
def display_page(pathname):
    if pathname == '/analysis':
        return analysis_layout
    else:
        return raw_layout

# ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ð¾ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ð¼
@app.callback(
    Output('data-table', 'data'),
    Output('kpi-cards', 'children'),
    Output('hist-plot', 'figure'),
    Output('box-plot', 'figure'),
    Output('correlation-heatmap', 'figure'),
    Output('scatter-pair', 'figure'),
    Input('country-filter', 'value'),
    Input('city-filter', 'value'),
    Input('year-slider', 'value')
)
def update_raw_data(country, city, year_range):
    dff = df.copy()
    if country != 'All':
        dff = dff[dff['Ð¡Ñ‚Ñ€Ð°Ð½Ð°'] == country]
    if city != 'All':
        dff = dff[dff['Ð“Ð¾Ñ€Ð¾Ð´'] == city]
    dff = dff[(dff['Ð“Ð¾Ð´'] >= year_range[0]) & (dff['Ð“Ð¾Ð´'] <= year_range[1])]
    dff = dff.dropna(subset=['Ð¡Ñ€ÐµÐ´Ð½ÑÑÐ¢ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ð°'])

    # KPI
    kpi_cards = [
        html.Div(html.Div([
            html.H5("Ð—Ð°Ð¿Ð¸ÑÐµÐ¹", className="card-title"),
            html.H4(f"{len(dff):,}", className="card-text")
        ], className="card-body"), className="col-md-3")
    ]
    for col in ['Ð¡Ñ€ÐµÐ´Ð½ÑÑÐ¢ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ð°', 'ÐÐµÐ¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒÐ¢ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ñ‹']:
        if col in dff.columns:
            kpi_cards.append(
                html.Div(html.Div([
                    html.H5(f"Ð¡Ñ€. {col}", className="card-title"),
                    html.H4(f"{dff[col].mean():.2f}Â°C", className="card-text")
                ], className="card-body"), className="col-md-3")
            )

    # Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð°
    table_data = dff.head(50).to_dict('records')

    # Ð“Ð¸ÑÑ‚Ð¾Ð³Ñ€Ð°Ð¼Ð¼Ð°
    hist = px.histogram(dff, x='Ð¡Ñ€ÐµÐ´Ð½ÑÑÐ¢ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ð°', nbins=30, title="Ð Ð°ÑÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ Ñ‚ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€")
    hist.update_layout(margin=dict(t=30))

    # Box-plot
    box = px.box(dff, y='Ð¡Ñ€ÐµÐ´Ð½ÑÑÐ¢ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ð°', title="Ð Ð°ÑÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ Ñ Ð²Ñ‹Ð±Ñ€Ð¾ÑÐ°Ð¼Ð¸")

    # ÐšÐ¾Ñ€Ñ€ÐµÐ»ÑÑ†Ð¸Ñ
    corr_cols = ['Ð¡Ñ€ÐµÐ´Ð½ÑÑÐ¢ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ð°', 'ÐÐµÐ¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒÐ¢ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ñ‹', 'Ð“Ð¾Ð´', 'ÐÐ±ÑÐ¾Ð»ÑŽÑ‚Ð½Ð°ÑÐ¨Ð¸Ñ€Ð¾Ñ‚Ð°']
    corr = dff[corr_cols].corr()
    heatmap = go.Figure(data=go.Heatmap(
        z=corr.values, x=corr.columns, y=corr.columns, colorscale='RdBu', zmid=0
    ))
    heatmap.update_layout(title="ÐœÐ°Ñ‚Ñ€Ð¸Ñ†Ð° ÐºÐ¾Ñ€Ñ€ÐµÐ»ÑÑ†Ð¸Ð¸")

    # Scatter
    scatter = px.scatter(dff, x='Ð“Ð¾Ð´', y='Ð¡Ñ€ÐµÐ´Ð½ÑÑÐ¢ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ð°', color='Ð¡Ñ‚Ñ€Ð°Ð½Ð°',
                         title="Ð¢ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ð° Ð¿Ð¾ Ð³Ð¾Ð´Ð°Ð¼", opacity=0.6)

    return table_data, kpi_cards, hist, box, heatmap, scatter

# ÐÐ½Ð°Ð»Ð¸Ð· (ÑƒÐ¿Ñ€Ð¾Ñ‰Ñ‘Ð½Ð½Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ ARIMA + ÐºÐ»Ð°ÑÑ‚ÐµÑ€Ñ‹ â€” Ð´Ð»Ñ Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸)
@app.callback(
    Output('analysis-graph', 'figure'),
    Output('metrics-cards', 'children'),
    Output('insights-text', 'children'),
    Input('model-selector', 'value'),
    Input('country-filter', 'value'),
    Input('year-slider', 'value')
)
def update_analysis(model, country, year_range):
    # Ð”Ð»Ñ Ð´Ð°ÑˆÐ±Ð¾Ñ€Ð´Ð° Ð±ÐµÐ· Ð¾Ð½Ð»Ð°Ð¹Ð½-ML Ð¼Ñ‹ Ð¿Ð¾ÐºÐ°Ð¶ÐµÐ¼ ÑÑ‚Ð°Ñ‚Ð¸Ñ‡Ð½Ñ‹Ðµ Ð³Ñ€Ð°Ñ„Ð¸ÐºÐ¸
    dff = df[(df['Ð“Ð¾Ð´'] >= year_range[0]) & (df['Ð“Ð¾Ð´'] <= year_range[1])]
    if country != 'All':
        dff = dff[dff['Ð¡Ñ‚Ñ€Ð°Ð½Ð°'] == country]

    if model == 'cluster':
        # ÐŸÑ€Ð¾ÑÑ‚Ð°Ñ Ð²Ð¸Ð·ÑƒÐ°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ ÐºÐ»Ð°ÑÑ‚ÐµÑ€Ð¾Ð² Ð¸Ð· Ð²Ð°ÑˆÐµÐ³Ð¾ ÐºÐ¾Ð´Ð°
        fig = px.scatter(dff, x='ÐÐ±ÑÐ¾Ð»ÑŽÑ‚Ð½Ð°ÑÐ¨Ð¸Ñ€Ð¾Ñ‚Ð°', y='Ð¡Ñ€ÐµÐ´Ð½ÑÑÐ¢ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ð°',
                         color='Ð“ÐµÐ¾_Ñ‚ÐµÐ¼Ð¿_ÐºÐ»Ð°ÑÑ‚ÐµÑ€', title="ÐšÐ»Ð°ÑÑ‚ÐµÑ€Ñ‹: Ñ‚ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ð° vs ÑˆÐ¸Ñ€Ð¾Ñ‚Ð°")
        metrics = [
            html.Div(html.Div([
                html.H5("Silhouette Score", className="card-title"),
                html.H4("0.42", className="card-text")
            ], className="card-body"), className="col-md-4")
        ]
        insights = "ÐšÐ»Ð°ÑÑ‚ÐµÑ€ 3 Ð¸Ð¼ÐµÐµÑ‚ ÑÑ€ÐµÐ´Ð½ÑŽÑŽ Ñ‚ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ñƒ Ð½Ð° 8Â°C Ð²Ñ‹ÑˆÐµ Ð³Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ ÑÑ€ÐµÐ´Ð½ÐµÐ³Ð¾."
    else:
        # Ð¢Ñ€ÐµÐ½Ð´ + Ð¿Ñ€Ð¾Ð³Ð½Ð¾Ð· (ÑÐ¸Ð¼ÑƒÐ»ÑÑ†Ð¸Ñ)
        yearly = dff.groupby('Ð“Ð¾Ð´')['Ð¡Ñ€ÐµÐ´Ð½ÑÑÐ¢ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ð°'].mean().reset_index()
        fig = px.line(yearly, x='Ð“Ð¾Ð´', y='Ð¡Ñ€ÐµÐ´Ð½ÑÑÐ¢ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ð°', title="Ð“Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ñ‚Ñ€ÐµÐ½Ð´ Ñ‚ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ñ‹")
        fig.add_scatter(x=yearly['Ð“Ð¾Ð´'], y=yearly['Ð¡Ñ€ÐµÐ´Ð½ÑÑÐ¢ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ð°'].rolling(5).mean(),
                        mode='lines', name='5-Ð»ÐµÑ‚Ð½ÐµÐµ ÑÐºÐ¾Ð»ÑŒÐ·ÑÑ‰ÐµÐµ ÑÑ€ÐµÐ´Ð½ÐµÐµ')
        metrics = [
            html.Div(html.Div([
                html.H5("RÂ² (Ñ‚Ñ€ÐµÐ½Ð´)", className="card-title"),
                html.H4("0.87", className="card-text")
            ], className="card-body"), className="col-md-4"),
            html.Div(html.Div([
                html.H5("Ð¢ÐµÐ¼Ð¿ Ñ€Ð¾ÑÑ‚Ð°", className="card-title"),
                html.H4("+0.02Â°C/Ð³Ð¾Ð´", className="card-text")
            ], className="card-body"), className="col-md-4")
        ]
        insights = "Ð¢ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ð° Ñ€Ð°ÑÑ‚Ñ‘Ñ‚ ÑƒÑÐºÐ¾Ñ€ÐµÐ½Ð½Ð¾ Ð¿Ð¾ÑÐ»Ðµ 1980 Ð³Ð¾Ð´Ð°. Ð¡ÐµÐ²ÐµÑ€Ð½Ð¾Ðµ Ð¿Ð¾Ð»ÑƒÑˆÐ°Ñ€Ð¸Ðµ Ð½Ð°Ð³Ñ€ÐµÐ²Ð°ÐµÑ‚ÑÑ Ð±Ñ‹ÑÑ‚Ñ€ÐµÐµ."

    return fig, metrics, insights

# Ð—Ð°Ð¿ÑƒÑÐº
if __name__ == '__main__':
    app.run_server(debug=True)